# Project Journal Notes
## Journal Guidelines
1. When requested by the user (i.e. "Please add to the journal"), add a log above the previous one
2. Run `date` to get the date and time, use that as the headline (Convert date to format-> Day MM/DD/YYYY HH:MM TMZ)
3. Write a brief summary of what has been changed or updated since the last journal. No need to document every little nuance. Include major changes, and current challenges at a high level
4. Treat them like a substantially detailed commit message with some details but keep it brief.


#### Entry: Wed 01/28/2026 19:20 PST
Fixed database seeding for v0.3 schema migration. Created migration `20260129030218_make_circular_fks_deferrable` to make User ↔ Owner circular FK constraints `DEFERRABLE INITIALLY DEFERRED`, enabling atomic creation of both records in a single transaction. Updated `seed.ts` and `createUserWithOwner()` in `user.ts` to work with deferred constraints. Made Supabase optional for local development - seed now uses local static files from `/public/static/examples/` when `NEXT_PUBLIC_SUPABASE_URL` isn't set, falling back to `/static/examples/filename.png` URLs that Next.js serves directly. Cleaned up verbose debug logging from seed file. Ready to run `npx prisma generate && npm run db:seed:dev` to complete seeding.

#### Entry: Wed 01/28/2026 18:09 PST
Eliminated type casting in server utilities by deriving types from Prisma schema. Added `OwnerFromQuery`, `ProjectFromQuery`, and `EventFromQuery` types to `fields.ts` using Prisma's `GetPayload` utility, making the schema the source of truth. Created `toProjectItem()` and `toEventItem()` transform functions that convert Prisma results to client types without `as unknown as` casts. Updated `PublicOwner` type to use `OwnerType` enum from Prisma instead of literal strings. Fixed outdated `PublicUser` type by replacing `actorId` with `ownerId` to match current schema. Added `isUserOwner()` and `isOrgOwner()` type guard helpers and `PublicOrg` type export. Removed backward compatibility for deprecated `dateTime` field in events API (now strictly `eventDateTime`). Refactored `getOwnerId()` to return `owner.id` directly, added `getOwnerHandle()` and `getOwnerEntityId()` for specific lookups. 70 TypeScript errors remain in seed file (29) and frontend components (41) pending refactor.

#### Entry: Mon 01/12/2026 21:27 PST
Implemented org creation feature. Added "Create Organization" button to user profile page and org creation form at `/orgs/new` with name, slug (auto-generated), headline, bio, interests, and location fields. Built `POST /api/orgs` endpoint with `validateOrgData()` validation. Added `createOrg()` server utility that creates Actor (type ORG), Org record, and OrgMember with OWNER role. Created slug generation utility for URL-safe slugs. Form follows existing profile creation patterns. Features marked "coming soon" (parent topic, admins, private/public) deferred pending schema changes.

#### Entry: Sun 01/11/2026 12:07 PST
Refactored routing architecture for unified actor-based design. Created unified profile routes `/u/profile` and `/o/profile` with matching edit and settings pages, replacing scattered profile routes. Implemented `ActorContext` to manage current actor state (user or org) throughout the app. Added org switching functionality via `/api/auth/switch-org` and `/api/auth/switch-to-user` routes. Consolidated API routes to `/api/me/*` pattern with unified `/api/me/actor` endpoint returning current actor based on session, replacing separate profile endpoints. Updated navigation bar to route to org profile when acting as org. Removed obsolete route constants and cleaned up unused profile pages. All profile pages now use consistent actor-based patterns with unified edit and settings functionality.

#### Entry: Fri 01/09/2026 21:45 PST
Implemented org profile functionality with "Switch to [Org] Profile" button on user profile page. Created public org profiles at `/o/[slug]` and private settings at `/profile/org/[slug]`, both using Actor-based components (`ActorProfileHeader`, `ActorProfileDisplay`) that work for both Users and Orgs. Added org server utilities and types. Enhanced project/event utilities with `getProjectsByActor()` and `getEventsByActor()` for unified actor handling. Fixed placeholder Supabase URLs in database via `fix-image-urls.ts` script. Added `displayName` field to User model with priority: `displayName` > `firstName + lastName` > `username`. Updated all display name utilities to use unified priority system.

#### Entry: Fri 01/09/2026 20:17 PST
Completed major schema migration from v1 to v2. Migrated Prisma schema to v2 introducing Actor abstraction layer (unified identity for Users and Orgs), replaced Entry model with Post model (standalone or descendant posts), and implemented polymorphic ImageAttachment system replacing direct foreign keys. Updated all TypeScript types, server utilities, API routes, and components to use new schema patterns (ownerActorId instead of ownerId, Actor relations, ImageAttachment queries). Split User.name into firstName/middleName/lastName fields. Added avatar support for Users and Orgs. Created comprehensive environment file system using Next.js conventions: `.env` (base config with AUTH_SECRET), `.env.development` (local database), `.env.production` (remote Supabase database). Updated all scripts to respect environment files: `npm run dev` uses local DB, `npm run dev:remote` uses production DB, `npm run db:seed:dev` seeds local, `npm run db:seed` seeds production. Created `db:migrate:deploy` script for production migrations. Updated seed script and `prisma.config.ts` to load environment files in correct order. Created deployment documentation (`docs/DEPLOYMENT.md`) explaining migration workflow. All code updated, migrations created, and local testing successful. Ready for production deployment.

#### Entry: Wed 12/31/2025 23:15 PST
Fixed client/server boundary issues and build errors. Refactored `AboutModal` to accept `username` as a prop instead of fetching internally. Created `user-client.ts` utility following existing patterns (`project-client.ts`, `event-client.ts`) with `fetchProfile()` function for client-side profile fetching. Updated `NavigationIcons` to properly fetch username using `fetchProfile()` utility with `useEffect` hook, fixing incorrect `await` usage in non-async component. Removed server-only imports from `auth-client.ts` (`getUserById`, `auth`) that were causing Prisma to be bundled into client bundle, breaking the build. Updated `layout.tsx` and `NavigationBar` to pass `session` prop through component tree instead of `userHomeLink`.

#### Entry: Tue 12/30/2025 21:43 PST
Extended edit and delete functionality to projects, matching events pattern. Added PUT/DELETE handlers to `/api/projects/[id]` with ownership verification. Created reusable `EditProjectForm` component for both create and edit modes, refactored `/projects/new` to use it. Added `DeleteProjectButton` with confirmation dialog. Implemented image cleanup: `deleteEvent()` and `deleteProject()` now remove associated images from Supabase storage bucket before deletion, preventing orphaned files. Database records cleaned up via Prisma cascade. Improved error handling to return specific error messages. Added `ProjectUpdateInput` type and validation. All project and event CRUD operations now follow consistent patterns.

#### Entry: Tue 12/30/2025 14:49 PST
Refactored image storage and entry system to use extensible polymorphic schema. Created new `Image` model in Prisma schema supporting multiple images per collection item (Project, Event) with alt text and upload tracking. Replaced single `imageUrl` field on Project and `imageUrls` array on Event with proper `Image` relations. Created new `Entry` model for collection updates/entries using polymorphic pattern (`collectionType` + `collectionId`) instead of explicit foreign keys, making it extensible for future collection types (Post, etc.). Removed obsolete `ProjectEntry`, `ProjectEntriesList`, and `ProjectEntryUpdate` components that no longer fit the schema. Refactored `ProjectCard` to inline project description, owner info, and image display logic. Created generic `entry-client.ts` with `getEntries(collectionId, collectionType)` function that works with any collection type. Updated seed file to upload local images from `public/static/examples` to Supabase `uploads/examples` bucket and create corresponding Image records. Fixed client/server boundary issues where client components were importing server-only Prisma code. Updated all TypeScript types to match new schema, removed deprecated `ProjectEntryItem` type. Created reusable Prisma field selection objects in `fields.ts` for consistent data fetching. Schema now supports multiple images per item and extensible entry system for all collection types.

#### Entry: Sat 12/27/2025 19:56 PST
Reorganized codebase to prevent client/server boundary issues. Moved all server-only files (prisma, project, event, user, message, project-entry) to `src/lib/utils/server/` folder with warning comments. Updated all imports across codebase to use new server paths. Fixed build error where client components were importing server code (ProjectEntriesList was importing from server file). Added proper type validation to server functions - `getProjectEntries()` and `createProjectEntry()` now explicitly return `ProjectEntryItem` types with proper field selection. Extracted navigation icons into reusable components (`src/lib/components/icons.tsx`). Created `LoginLogoutIcon` component to handle authentication UI. Added "New Entry" button to project detail page (visible only to project owners) with new entry creation page at `/projects/[id]/entries/new`. Created `CLIENT_SERVER_BOUNDARIES.md` guide documenting best practices for avoiding client/server import issues.

#### Entry: Sat 12/27/2025 18:33 PST
Fixed first production bug: email case sensitivity causing login failures. Prisma/PostgreSQL email lookups are case-sensitive, causing `Diana.example@example.com` to fail against seed data with lowercase `diana.example@example.com`. Normalized emails to lowercase in `authorize()` function (`src/lib/auth.ts`) and signup route before database operations. Added logout button to NavigationBar.

#### Entry: Sat 12/27/2025 16:53 PST
Resolved Vercel/Supabase deployment issues. Fixed Prisma build error by removing duplicate `generator client` block in `schema.prisma` (had two conflicting generator definitions). Fixed NextAuth session 500 errors by adding `secret` configuration to NextAuth config (`AUTH_SECRET` or `NEXTAUTH_SECRET` env var required for production). Added comprehensive error handling to auth flow: wrapped `authorize` function and `session` callback in try-catch blocks to prevent unhandled errors from causing 500 responses. Added `jwt` callback to properly store user ID in token for session retrieval. Improved Prisma client initialization in `src/lib/utils/prisma.ts` with better error messages and connection pool settings for serverless environments. Deployment now requires `AUTH_SECRET` environment variable to be set in Vercel dashboard. MVP is COMPLETE!

#### Entry: Thu 12/25/2025 22:31 PST
Extracted filtering and sorting logic into reusable components. Created `useFilter` hook to encapsulate filter/sort/view state management. Built `FilterBoard` component for UI controls (search, filter tabs, sort dropdown, view toggles). Reorganized `CollectionPage` as presentational component accepting all state/handlers as props. Refactored `collections/page.tsx` to client component handling data fetching and state, passing props to `CollectionPage`. Added personal collection section to profile page (`/profile`) displaying user's projects and events with full filtering/sorting capabilities. Made `CollectionPage` reusable with optional `title` prop for context-specific headers. Architecture now cleanly separates data fetching (client/server), state management (hooks), and presentation (components).

#### Entry: Thu 12/25/2025 21:54 PST
Refactored collections rendering architecture. Created `FilteredCollection` component to handle view state (map/list/grid) and render appropriate card types directly (ProjectCard/EventCard), making `CollectionCard` obsolete. Extracted `CollectionItemCard` helper to DRY up card rendering logic. Added events to seed data (two events from admin and alice users). Renamed type interfaces: `Event` → `EventItem` and `Project` → `ProjectItem` to avoid conflicts with DOM Event type, updated all references across codebase.

#### Entry: Thu 12/25/2025 17:47 PST
Completed Milestone F code review and implemented type discriminator pattern. Added `type` field to Prisma schema (Project/Event models) with defaults, making database the source of truth. Refactored type guards to use discriminator field. Created shared collection utilities (`src/lib/utils/collection.ts`) eliminating ~60 lines of duplicated filtering/sorting logic between collections pages. Updated migrations to include `type` field properly. All utility functions now return data directly from Prisma without manual type mapping.

#### Entry: Thu 12/25/2025 14:46 PST
Normalized project data fetching and aligned type system with Prisma schema. Refactored project utilities to remove transformation layer - types now match Prisma directly (Date fields instead of string, no manual conversion). Created `PublicUser` type matching `publicUserFields` selection and updated `Project` interface to use `PublicUser` for owner instead of limited `ProjectOwner`. Updated `getInitials()` to accept `PublicUser` object. Renamed `publicProfileFields` to `publicUserFields` throughout codebase for consistency. Refactored component structure: moved project entry content to `ProjectEntry` component, updated `ProfilePicPlaceholder` to accept full project and made circle clickable link to user profile. Added client-side fetch utilities (`fetchProjects`, `fetchProjectById`) in `project.ts` for consistent API usage. All server-side functions now return Prisma results directly without transformation, ensuring type safety and eliminating unnecessary data conversion overhead.

#### Entry: Tue 12/23/2025 14:13 PST
Completed messaging feature implementation (Milestone E - messaging components). Added Message model to Prisma schema with sender/receiver relations and User model updates. Created message utilities (`src/lib/utils/message.ts`) with `getConversations()`, `getMessages()`, and `sendMessage()` functions. Added message validation (`validateMessageContent()`) and TypeScript types (`src/lib/types/message.ts`). Built API routes: GET/POST `/api/messages` for conversations list and sending messages, GET `/api/messages/[userId]` for individual conversation threads. Created frontend pages: `/messages` (conversations list with last message preview) and `/messages/[userId]` (individual conversation with message input). Added "Messages" link to navigation sidebar (visible when logged in). Integrated message buttons on user profile pages (`/u/[username]`) and project detail pages (`/projects/[id]`) to start conversations. Updated `getUserByUsername()` to include user ID for messaging functionality. Updated README with WSL/Ubuntu PostgreSQL setup instructions. Database migration pending - need to configure PostgreSQL authentication (setting postgres user password). All messaging endpoints are protected and include validation (prevents self-messaging, validates content length).

#### Entry: Thu 12/18/25 22:42 PST
Implemented image upload feature for projects (Milestone E - image components). Added `imageUrl` field to Project model in Prisma schema, created migration. Built image upload API route (`/api/projects/upload`) with file validation (type, size limits). Updated project creation form to support image upload with preview. Enhanced project list and detail pages to display images using Next.js Image component. Fixed ESLint configuration issues by creating custom `eslint.config.mjs` with TypeScript, React, and React Hooks support (workaround for Next.js 16.0.10 `next lint` bug). Migrated from `middleware.ts` to `proxy.ts` per Next.js 16 deprecation. Fixed image display issues by switching from `fill` prop to explicit dimensions. Reorganized code structure (moved utilities to `src/lib/utils/`). Added uploads directory to `.gitignore`. Images now display correctly on project listings and detail pages.

#### Entry: Thu 12/18/25 17:56 PST
Completed Milestone C MVP (Projects). Created plan document (`ai-tools/MILESTONE_C_PLAN.md`). Added Project model to Prisma schema with User relation, ran migration. Created `src/lib/project.ts` with utility functions and extended validations for projects. API routes: GET/POST `/api/projects` (public listing with search, protected create) and GET `/api/projects/[id]`. Frontend: Created `/projects` (public listing), `/projects/new` (protected form), and `/projects/[id]` (public detail) pages. Updated navigation with Projects and New Project links. Standardized auth handling across client and server components.

#### Entry: Thu 12/18/25 16:59 PST
Completed pre-Milestone C refactoring and code review. Created `src/lib/errors.ts` with standardized error response helpers (unauthorized, notFound, badRequest, serverError). Created `src/lib/validations.ts` with reusable validation functions for email, username, password, and profile data. Extended `src/lib/user.ts` with `updateUserProfile()` function to extract profile update logic from API routes. Updated `/api/profile` and `/api/auth/signup` routes to use new utility functions for consistency. Documented that DELETE operation is intentionally omitted from MVP. Created comprehensive milestone review document (`ai-tools/MILESTONE_REVIEW.md`) confirming Milestone A and B completion. All refactors improve code maintainability, testability, and consistency. Ready to proceed with Milestone C (Projects).

#### Entry: Wed 12/17/25 17:34 PST
Completed Milestone B (User Profile). Created `/profile`, `/profile/edit`, and `/u/[username]` pages with API routes. Added `src/lib/user.ts` utility for reusable profile queries. Fixed session user.id not being passed through by adding NextAuth callback. Added SessionProvider to layout for client-side session access. Added profile link to home page and logged-in banner to login page.

#### Entry: Wed 12/17/25 17:16 PST
Completed Milestone A (Authentication). Fixed Prisma v7 compatibility by adding `@prisma/adapter-pg` driver adapter. Added protected route middleware using session cookie check (Edge runtime compatible). Created bare-bones `/profile` page for testing auth redirect. Fixed Tailwind v4 PostCSS config and module format issues.

#### Entry: Wed 12/17/25 16:54 PST
Implemented authentication (Milestone A). Added NextAuth with credentials provider, bcrypt password hashing, signup API route, and login/signup pages. Created Prisma client singleton in `src/lib/`. Auth flow: signup creates user with hashed password, login validates credentials against database.

#### Entry: Wed 12/17/25 16:33 PST
Connected local PostgreSQL to Prisma. Fixed Prisma v7 config issue (URL moved from `schema.prisma` to `prisma.config.ts`). Ran first migration successfully—`users` table now exists in local database. Updated `.env` with correct connection string format for local dev.

#### Entry: Wed 12/17/25 16:03 PST
Added Prisma ORM with PostgreSQL. Created initial User model in `prisma/schema.prisma` covering auth fields (email, passwordHash, username) and profile fields (name, headline, bio, interests, location). Added `database/README.md` with local PostgreSQL setup instructions. Next: configure local PostgreSQL and run initial migration.

#### Entry: Wed 12/17/25 15:54 PST
Initialized Next.js project manually (App Router, TypeScript, Tailwind CSS). Created core config files: `tsconfig.json`, `next.config.ts`, `tailwind.config.ts`, `postcss.config.mjs`. Set up base `src/app/` structure with layout, page, and global styles. Added `.gitignore` for node_modules and build artifacts. Project is now runnable with `npm run dev`.

#### Entry: Wed 12/17/25 15:38 PST
I initialized the project plan and a folder with tools for the AI Agent such as the project guidelines with best practices, and the journal for notes about sessions and what has been done. No git or code yet.

